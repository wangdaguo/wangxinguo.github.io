---
layout: post
title: æ–‡ç« åˆ—è¡¨æŸ¥çœ‹
date: 2024-06-26 12:51 +0800
categories: [TJU-news, æ–‡ç« ]
author: <author_id>  
---

# æ–‡ç« åˆ—è¡¨åŠ è½½

## æ–‡ç« åŠ è½½

**å±•ç¤ºæ–¹å¼ï¼š**

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626125828684.png" alt="image-20240626125828684" style="zoom:35%;" />

**åŠ è½½æ–¹å¼ï¼š**

è¯´æ˜ï¼šæ–‡ç« æ˜¯æŒ‰å‘å¸ƒæ—¶é—´å€’åºå±•ç¤ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€ä¸Šé¢çš„ä¸ºæœ€æ–°çš„æ–‡ç« ï¼›

1. åœ¨é»˜è®¤é¢‘é“å±•ç¤º10æ¡æ–‡ç« ä¿¡æ¯ï¼›
2. å¯ä»¥åˆ‡æ¢é¢‘é“æŸ¥çœ‹ä¸åŒç§ç±»æ–‡ç« ï¼›
3. å½“ç”¨æˆ·ä¸‹æ‹‰å¯ä»¥åŠ è½½ **æœ€æ–°** çš„æ–‡ç« ï¼ˆåˆ†é¡µï¼‰ï¼Œæœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´ä¸ºæœ€å¤§çš„æ—¶é—´ï¼ˆæœ€ä¸Šé¢ä¸€ç¯‡ï¼‰ä¸ºä¾æ®ï¼›
4. å½“ç”¨æˆ·ä¸Šæ‹‰å¯ä»¥åŠ è½½ **æ›´å¤š** çš„æ–‡ç« ä¿¡æ¯ï¼ˆæŒ‰ç…§å‘å¸ƒæ—¶é—´ï¼‰ï¼Œæœ¬é¡µæ–‡ç« åˆ—è¡¨ä¸­å‘å¸ƒæ—¶é—´æœ€å°çš„æ—¶é—´ï¼ˆæœ€ä¸‹é¢ä¸€ç¯‡ï¼‰ä¸ºä¾æ®ï¼›

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626131653428.png" alt="image-20240626131653428" style="zoom:35%;" />

5. å¦‚æœæ˜¯å½“å‰é¢‘é“çš„é¦–é¡µï¼Œå‰ç«¯ä¼ é€’é»˜è®¤å‚æ•°ï¼š

- maxBehotTimeï¼š0ï¼ˆæ¯«ç§’ï¼‰

- minBehotTimeï¼š20000000000000ï¼ˆæ¯«ç§’ï¼‰--->2063å¹´



## è¡¨ç»“æ„åˆ†æ

|     **è¡¨åç§°**     |           **è¯´æ˜**           |
| :----------------: | :--------------------------: |
|     ap_article     | æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç«  |
| ap_article_config  |     APPå·²å‘å¸ƒæ–‡ç« é…ç½®è¡¨      |
| ap_article_content |     APPå·²å‘å¸ƒæ–‡ç« å†…å®¹è¡¨      |
|     ap_author      |      APPæ–‡ç« ä½œè€…ä¿¡æ¯è¡¨       |
|   ap_collection    |        APPæ”¶è—ä¿¡æ¯è¡¨         |

**`ap_article`  æ–‡ç« åŸºæœ¬ä¿¡æ¯è¡¨ï¼š**

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626130238730.png" alt="image-20240626130238730" style="zoom:40%;" />

**`ap_article_config`  æ–‡ç« é…ç½®è¡¨ï¼š**

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626130340408.png" alt="image-20240626130340408" style="zoom:43%;" />

**`ap_article_content` æ–‡ç« å†…å®¹è¡¨ï¼š**

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626130508552.png" alt="image-20240626130508552" style="zoom:45%;" />

**ä¸‰å¼ è¡¨å…³ç³»åˆ†æï¼š**

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626130630830.png" alt="image-20240626130630830" style="zoom:40%;" />

- **å¯¹åº”çš„å®ä½“ï¼š**

`ap_article` æ–‡ç« è¡¨å¯¹åº”å®ä½“ï¼š

```java
/**
 * <p>
 * æ–‡ç« ä¿¡æ¯è¡¨ï¼Œå­˜å‚¨å·²å‘å¸ƒçš„æ–‡ç« 
 * </p>
 *
 * @author itheima
 */

@Data
@TableName("ap_article")
public class ApArticle implements Serializable {

    @TableId(value = "id",type = IdType.ID_WORKER)
    private Long id;


    /**
     * æ ‡é¢˜
     */
    private String title;

    /**
     * ä½œè€…id
     */
    @TableField("author_id")
    private Long authorId;

    /**
     * ä½œè€…åç§°
     */
    @TableField("author_name")
    private String authorName;

    /**
     * é¢‘é“id
     */
    @TableField("channel_id")
    private Integer channelId;

    /**
     * é¢‘é“åç§°
     */
    @TableField("channel_name")
    private String channelName;

    /**
     * æ–‡ç« å¸ƒå±€  0 æ— å›¾æ–‡ç«    1 å•å›¾æ–‡ç«     2 å¤šå›¾æ–‡ç« 
     */
    private Short layout;

    /**
     * æ–‡ç« æ ‡è®°  0 æ™®é€šæ–‡ç«    1 çƒ­ç‚¹æ–‡ç«    2 ç½®é¡¶æ–‡ç«    3 ç²¾å“æ–‡ç«    4 å¤§V æ–‡ç« 
     */
    private Byte flag;

    /**
     * æ–‡ç« å°é¢å›¾ç‰‡ å¤šå¼ é€—å·åˆ†éš”
     */
    private String images;

    /**
     * æ ‡ç­¾
     */
    private String labels;

    /**
     * ç‚¹èµæ•°é‡
     */
    private Integer likes;

    /**
     * æ”¶è—æ•°é‡
     */
    private Integer collection;

    /**
     * è¯„è®ºæ•°é‡
     */
    private Integer comment;

    /**
     * é˜…è¯»æ•°é‡
     */
    private Integer views;

    /**
     * çœå¸‚
     */
    @TableField("province_id")
    private Integer provinceId;

    /**
     * å¸‚åŒº
     */
    @TableField("city_id")
    private Integer cityId;

    /**
     * åŒºå¿
     */
    @TableField("county_id")
    private Integer countyId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField("created_time")
    private Date createdTime;

    /**
     * å‘å¸ƒæ—¶é—´
     */
    @TableField("publish_time")
    private Date publishTime;

    /**
     * åŒæ­¥çŠ¶æ€
     */
    @TableField("sync_status")
    private Boolean syncStatus;

    /**
     * æ¥æº
     */
    private Boolean origin;

    /**
     * é™æ€é¡µé¢åœ°å€
     */
    @TableField("static_url")
    private String staticUrl;
}
```

`ap_article_config`æ–‡ç« é…ç½®å¯¹åº”å®ä½“ç±»ï¼š

```java
@Data
@TableName("ap_article_config")
public class ApArticleConfig implements Serializable {

    @TableId(value = "id",type = IdType.ID_WORKER)
    private Long id;

    /**
     * æ–‡ç« id
     */
    @TableField("article_id")
    private Long articleId;

    /**
     * æ˜¯å¦å¯è¯„è®º
     * true: å¯ä»¥è¯„è®º   1
     * false: ä¸å¯è¯„è®º  0
     */
    @TableField("is_comment")
    private Boolean isComment;

    /**
     * æ˜¯å¦è½¬å‘
     * true: å¯ä»¥è½¬å‘   1
     * false: ä¸å¯è½¬å‘  0
     */
    @TableField("is_forward")
    private Boolean isForward;

    /**
     * æ˜¯å¦ä¸‹æ¶
     * true: ä¸‹æ¶   1
     * false: æ²¡æœ‰ä¸‹æ¶  0
     */
    @TableField("is_down")
    private Boolean isDown;

    /**
     * æ˜¯å¦å·²åˆ é™¤
     * true: åˆ é™¤   1
     * false: æ²¡æœ‰åˆ é™¤  0
     */
    @TableField("is_delete")
    private Boolean isDelete;
}
```

`ap_article_content` æ–‡ç« å†…å®¹å¯¹åº”çš„å®ä½“ç±»ï¼š

```java
@Data
@TableName("ap_article_content")
public class ApArticleContent implements Serializable {

    @TableId(value = "id",type = IdType.ID_WORKER)
    private Long id;

    /**
     * æ–‡ç« id
     */
    @TableField("article_id")
    private Long articleId;

    /**
     * æ–‡ç« å†…å®¹
     */
    private String content;
}
```



## è¡¨çš„æ‹†åˆ†

**å‚ç›´åˆ†è¡¨ï¼š**å°†ä¸€ä¸ªè¡¨çš„å­—æ®µåˆ†æ•£åˆ°å¤šä¸ªè¡¨ä¸­ï¼Œæ¯ä¸ªè¡¨å­˜å‚¨å…¶ä¸­ä¸€éƒ¨åˆ†å­—æ®µã€‚

**ä¼˜åŠ¿ï¼š**

1. å‡å°‘IOäº‰æŠ¢ï¼Œå‡å°‘é”è¡¨çš„å‡ ç‡ï¼ŒæŸ¥çœ‹æ–‡ç« æ¦‚è¿°ä¸æ–‡ç« è¯¦æƒ…äº’ä¸å½±å“ï¼›
2. å……åˆ†å‘æŒ¥é«˜é¢‘æ•°æ®çš„æ“ä½œæ•ˆç‡ï¼Œå¯¹æ–‡ç« æ¦‚è¿°æ•°æ®æ“ä½œçš„é«˜æ•ˆç‡ä¸ä¼šè¢«æ“ä½œæ–‡ç« è¯¦æƒ…æ•°æ®çš„ä½æ•ˆç‡æ‰€æ‹–ç´¯ã€‚

**æ‹†åˆ†è§„åˆ™ï¼š**

1. æŠŠä¸å¸¸ç”¨çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ï¼›
2. æŠŠ `text`ï¼Œ`blob` ç­‰å¤§å­—æ®µæ‹†åˆ†å‡ºæ¥å•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ï¼›
3. ç»å¸¸ç»„åˆæŸ¥è¯¢çš„å­—æ®µå•ç‹¬æ”¾åœ¨ä¸€å¼ è¡¨ä¸­ã€‚



## æ¥å£å®šä¹‰

|          |     **åŠ è½½é¦–é¡µ**     |       **åŠ è½½æ›´å¤š**       |      **åŠ è½½æœ€æ–°**       |
| :------: | :------------------: | :----------------------: | :---------------------: |
| æ¥å£è·¯å¾„ | /api/v1/article/load | /api/v1/article/loadmore | /api/v1/article/loadnew |
| è¯·æ±‚æ–¹å¼ |         POST         |           POST           |          POST           |
|   å‚æ•°   |    ArticleHomeDto    |      ArticleHomeDto      |     ArticleHomeDto      |
| å“åº”ç»“æœ |    ResponseResult    |      ResponseResult      |     ResponseResult      |

`ArticleHomeDto`ï¼š

```java
@Data
public class ArticleHomeDto {

    // æœ€å¤§æ—¶é—´
    Date maxBehotTime;
    // æœ€å°æ—¶é—´
    Date minBehotTime;
    // åˆ†é¡µsize
    Integer size;
    // é¢‘é“ID
    String tag;
}
```

## é…ç½®éƒ¨åˆ†

å¯¼å…¥ `TJU-campus-article` å¾®æœåŠ¡

åœ¨ `TJU-campus-service` çš„ `pom` æ–‡ä»¶å¤¹ä¸­æ·»åŠ å­æ¨¡å—ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š

```xml
<modules>
    <module>TJU-campus-article</module>
</modules>
```

åœ¨`nacos`ä¸­æ·»åŠ å¯¹åº”çš„é…ç½®ï¼š

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/leadnews_article?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    username: ****
    password: ****
# è®¾ç½®Mapperæ¥å£æ‰€å¯¹åº”çš„XMLæ–‡ä»¶ä½ç½®ï¼Œå¦‚æœä½ åœ¨Mapperæ¥å£ä¸­æœ‰è‡ªå®šä¹‰æ–¹æ³•ï¼Œéœ€è¦è¿›è¡Œè¯¥é…ç½®
mybatis-plus:
  mapper-locations: classpath*:mapper/*.xml
  # è®¾ç½®åˆ«ååŒ…æ‰«æè·¯å¾„ï¼Œé€šè¿‡è¯¥å±æ€§å¯ä»¥ç»™åŒ…ä¸­çš„ç±»æ³¨å†Œåˆ«å
  type-aliases-package: com.shawen.model.article.pojos
```

## å…·ä½“å®ç°éƒ¨åˆ†

**Controllerï¼š**

```java
@RestController
@RequestMapping("/api/v1/article")
public class ArticleHomeController {

    @Autowired
    private ApArticleService apArticleService;

    /**
     * åŠ è½½é¦–é¡µ
     * @param dto
     * @return
     */
    @PostMapping("/load")
    public ResponseResult load(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);
    }

    /**
     * åŠ è½½æ›´å¤š
     * @param dto
     * @return
     */
    @PostMapping("/loadmore")
    public ResponseResult loadMore(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_MORE,dto);
    }

    /**
     * åŠ è½½æœ€æ–°
     * @param dto
     * @return
     */
    @PostMapping("/loadnew")
    public ResponseResult loadNew(@RequestBody ArticleHomeDto dto) {
        return apArticleService.load(ArticleConstants.LOADTYPE_LOAD_NEW,dto);
    }
}
```

**mapperï¼š**

```java
@Mapper
public interface ApArticleMapper extends BaseMapper<ApArticle> {

    /**
     * åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param dto
     * @param type  1 åŠ è½½æ›´å¤š 2 åŠ è½½æ›´æ–°
     * @return
     */
    public List<ApArticle> loadArticleList(@Param("dto") ArticleHomeDto dto, @Param("type") Short type);

}
```

å¯¹åº”çš„æ˜ å°„æ–‡ä»¶

åœ¨ `resources` ä¸­æ–°å»º `mapper/ApArticleMapper.xml`     å¦‚ä¸‹é…ç½®ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shawen.article.mapper.ApArticleMapper">

    <resultMap id="resultMap" type="com.shawen.model.article.pojos.ApArticle">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author_id" property="authorId"/>
        <result column="author_name" property="authorName"/>
        <result column="channel_id" property="channelId"/>
        <result column="channel_name" property="channelName"/>
        <result column="layout" property="layout"/>
        <result column="flag" property="flag"/>
        <result column="images" property="images"/>
        <result column="labels" property="labels"/>
        <result column="likes" property="likes"/>
        <result column="collection" property="collection"/>
        <result column="comment" property="comment"/>
        <result column="views" property="views"/>
        <result column="province_id" property="provinceId"/>
        <result column="city_id" property="cityId"/>
        <result column="county_id" property="countyId"/>
        <result column="created_time" property="createdTime"/>
        <result column="publish_time" property="publishTime"/>
        <result column="sync_status" property="syncStatus"/>
        <result column="static_url" property="staticUrl"/>
    </resultMap>
    <select id="loadArticleList" resultMap="resultMap">
        SELECT
        aa.*
        FROM
        `ap_article` aa
        LEFT JOIN ap_article_config aac ON aa.id = aac.article_id
        <where>
            and aac.is_delete != 1
            and aac.is_down != 1
            <!-- loadmore -->
            <if test="type != null and type == 1">
                and aa.publish_time <![CDATA[<]]> #{dto.minBehotTime}
            </if>
            <if test="type != null and type == 2">
                and aa.publish_time <![CDATA[>]]> #{dto.maxBehotTime}
            </if>
            <if test="dto.tag != '__all__'">
                and aa.channel_id = #{dto.tag}
            </if>
        </where>
        order by aa.publish_time desc
        limit #{dto.size}
    </select>

</mapper>
```

**Service && Implï¼š**

```java
public interface ApArticleService extends IService<ApArticle> {

    /**
     * æ ¹æ®å‚æ•°åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param loadtype 1ä¸ºåŠ è½½æ›´å¤š  2ä¸ºåŠ è½½æœ€æ–°
     * @param dto
     * @return
     */
    ResponseResult load(Short loadtype, ArticleHomeDto dto);

}
```



```java
@Service
@Transactional
@Slf4j
public class ApArticleServiceImpl  extends ServiceImpl<ApArticleMapper, ApArticle> implements ApArticleService {

    // å•é¡µæœ€å¤§åŠ è½½çš„æ•°å­—
    private final static short MAX_PAGE_SIZE = 50;

    @Autowired
    private ApArticleMapper apArticleMapper;

    /**
     * æ ¹æ®å‚æ•°åŠ è½½æ–‡ç« åˆ—è¡¨
     * @param loadtype 1ä¸ºåŠ è½½æ›´å¤š  2ä¸ºåŠ è½½æœ€æ–°
     * @param dto
     * @return
     */
    @Override
    public ResponseResult load(Short loadtype, ArticleHomeDto dto) {
        //1.æ ¡éªŒå‚æ•°
        Integer size = dto.getSize();
        if(size == null || size == 0){
            size = 10;
        }
        size = Math.min(size,MAX_PAGE_SIZE);
        dto.setSize(size);

        //ç±»å‹å‚æ•°æ£€éªŒ
        if(!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_MORE)&&!loadtype.equals(ArticleConstants.LOADTYPE_LOAD_NEW)){
            loadtype = ArticleConstants.LOADTYPE_LOAD_MORE;
        }
        //æ–‡ç« é¢‘é“æ ¡éªŒ
        if(StringUtils.isEmpty(dto.getTag())){
            dto.setTag(ArticleConstants.DEFAULT_TAG);
        }

        //æ—¶é—´æ ¡éªŒ
        if(dto.getMaxBehotTime() == null) dto.setMaxBehotTime(new Date());
        if(dto.getMinBehotTime() == null) dto.setMinBehotTime(new Date());
        //2.æŸ¥è¯¢æ•°æ®
        List<ApArticle> apArticles = apArticleMapper.loadArticleList(dto, loadtype);

        //3.ç»“æœå°è£…
        ResponseResult responseResult = ResponseResult.okResult(apArticles);
        return responseResult;
    }
    
}
```

**constantsï¼š**

```java
package com.shawen.common.constants;

public class ArticleConstants {
    public static final Short LOADTYPE_LOAD_MORE = 1;
    public static final Short LOADTYPE_LOAD_NEW = 2;
    public static final String DEFAULT_TAG = "__all__";
}
```

åœ¨ app ç½‘å…³çš„å¾®æœåŠ¡çš„ nacos çš„é…ç½®ä¸­å¿ƒæ·»åŠ æ–‡ç« å¾®æœåŠ¡çš„è·¯ç”±ï¼Œå®Œæ•´é…ç½®å¦‚ä¸‹ï¼š

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # åŒ¹é…æ‰€æœ‰è¯·æ±‚
            allowedOrigins: "*" #è·¨åŸŸå¤„ç† å…è®¸æ‰€æœ‰çš„åŸŸ
            allowedMethods: # æ”¯æŒçš„æ–¹æ³•
              - GET
              - POST
              - PUT
              - DELETE
      routes:
        # ç”¨æˆ·å¾®æœåŠ¡
        - id: user
          uri: lb://leadnews-user
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix= 1
        # æ–‡ç« å¾®æœåŠ¡
        - id: article
          uri: lb://leadnews-article
          predicates:
            - Path=/article/**
          filters:
            - StripPrefix= 1
```



# å¯¹è±¡å­˜å‚¨æœåŠ¡ MinIO

## å°è£… MinIO ä¸º starter

åœ¨ `TJU-campus-basic` æ¨¡å—ä¸‹åˆ›å»º `TJU-campus-starter`ï¼›

**å¯¼å…¥ä¾èµ–ï¼š**

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-autoconfigure</artifactId>
        </dependency>
        <dependency>
            <groupId>io.minio</groupId>
            <artifactId>minio</artifactId>
            <version>7.1.0</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-configuration-processor</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
    </dependencies>
```

## é…ç½®ç±»

**MinIOConfigProperties**

```java
package com.shawen.file.config;

@Data
@ConfigurationProperties(prefix = "minio")  // æ–‡ä»¶ä¸Šä¼  é…ç½®å‰ç¼€file.oss
public class MinIOConfigProperties implements Serializable {

    private String accessKey;
    private String secretKey;
    private String bucket;
    private String endpoint;
    private String readPath;
}
```

**MinIOConfig**

```java
package com.shawen.file.config;

@Data
@Configuration
@EnableConfigurationProperties({MinIOConfigProperties.class})
//å½“å¼•å…¥ FileStorageService æ¥å£æ—¶
@ConditionalOnClass(FileStorageService.class)
public class MinIOConfig {

    @Autowired
    private MinIOConfigProperties minIOConfigProperties;

    @Bean
    public MinioClient buildMinioClient() {
        return MinioClient
                .builder()
                .credentials(minIOConfigProperties.getAccessKey(), minIOConfigProperties.getSecretKey())
                .endpoint(minIOConfigProperties.getEndpoint())
                .build();
    }
}
```

## å°è£…æ“ä½œ minIO ç±»

**FileStorageServiceï¼š**

```java
public interface FileStorageService {


    /**
     *  ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename  æ–‡ä»¶å
     * @param inputStream æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    public String uploadImgFile(String prefix, String filename,InputStream inputStream);

    /**
     *  ä¸Šä¼ htmlæ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename   æ–‡ä»¶å
     * @param inputStream  æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    public String uploadHtmlFile(String prefix, String filename,InputStream inputStream);

    /**
     * åˆ é™¤æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     */
    public void delete(String pathUrl);

    /**
     * ä¸‹è½½æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     * @return
     *
     */
    public byte[]  downLoadFile(String pathUrl);

}
```

**MinIOFileStorageServiceï¼š**

```java
@Slf4j
@EnableConfigurationProperties(MinIOConfigProperties.class)
@Import(MinIOConfig.class)
public class MinIOFileStorageService implements FileStorageService {

    @Autowired
    private MinioClient minioClient;

    @Autowired
    private MinIOConfigProperties minIOConfigProperties;

    private final static String separator = "/";

    /**
     * @param dirPath
     * @param filename  yyyy/mm/dd/file.jpg
     * @return
     */
    public String builderFilePath(String dirPath,String filename) {
        StringBuilder stringBuilder = new StringBuilder(50);
        if(!StringUtils.isEmpty(dirPath)){
            stringBuilder.append(dirPath).append(separator);
        }
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
        String todayStr = sdf.format(new Date());
        stringBuilder.append(todayStr).append(separator);
        stringBuilder.append(filename);
        return stringBuilder.toString();
    }

    /**
     *  ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename  æ–‡ä»¶å
     * @param inputStream æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadImgFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("image/jpg")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     *  ä¸Šä¼ htmlæ–‡ä»¶
     * @param prefix  æ–‡ä»¶å‰ç¼€
     * @param filename   æ–‡ä»¶å
     * @param inputStream  æ–‡ä»¶æµ
     * @return  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public String uploadHtmlFile(String prefix, String filename,InputStream inputStream) {
        String filePath = builderFilePath(prefix, filename);
        try {
            PutObjectArgs putObjectArgs = PutObjectArgs.builder()
                    .object(filePath)
                    .contentType("text/html")
                    .bucket(minIOConfigProperties.getBucket()).stream(inputStream,inputStream.available(),-1)
                    .build();
            minioClient.putObject(putObjectArgs);
            StringBuilder urlPath = new StringBuilder(minIOConfigProperties.getReadPath());
            urlPath.append(separator+minIOConfigProperties.getBucket());
            urlPath.append(separator);
            urlPath.append(filePath);
            return urlPath.toString();
        }catch (Exception ex){
            log.error("minio put file error.",ex);
            ex.printStackTrace();
            throw new RuntimeException("ä¸Šä¼ æ–‡ä»¶å¤±è´¥");
        }
    }

    /**
     * åˆ é™¤æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     */
    @Override
    public void delete(String pathUrl) {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        // åˆ é™¤Objects
        RemoveObjectArgs removeObjectArgs = RemoveObjectArgs.builder().bucket(bucket).object(filePath).build();
        try {
            minioClient.removeObject(removeObjectArgs);
        } catch (Exception e) {
            log.error("minio remove file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }
    }


    /**
     * ä¸‹è½½æ–‡ä»¶
     * @param pathUrl  æ–‡ä»¶å…¨è·¯å¾„
     * @return  æ–‡ä»¶æµ
     *
     */
    @Override
    public byte[] downLoadFile(String pathUrl)  {
        String key = pathUrl.replace(minIOConfigProperties.getEndpoint()+"/","");
        int index = key.indexOf(separator);
        String bucket = key.substring(0,index);
        String filePath = key.substring(index+1);
        InputStream inputStream = null;
        try {
            inputStream = minioClient.getObject(GetObjectArgs.builder().bucket(minIOConfigProperties.getBucket()).object(filePath).build());
        } catch (Exception e) {
            log.error("minio down file error.  pathUrl:{}",pathUrl);
            e.printStackTrace();
        }

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        byte[] buff = new byte[100];
        int rc = 0;
        while (true) {
            try {
                if (!((rc = inputStream.read(buff, 0, 100)) > 0)) break;
            } catch (IOException e) {
                e.printStackTrace();
            }
            byteArrayOutputStream.write(buff, 0, rc);
        }
        return byteArrayOutputStream.toByteArray();
    }
}
```

## å¯¹å¤–åŠ å…¥è‡ªåŠ¨é…ç½®

åœ¨ resources ä¸­æ–°å»º`META-INF/spring.factories`

```java
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
  com.shawen.file.service.impl.MinIOFileStorageService
```

## å…¶ä»–å¾®æœåŠ¡ä½¿ç”¨

ç¬¬ä¸€ï¼Œå¯¼å…¥ `TJU-campus-starter` çš„ä¾èµ–

ç¬¬äºŒï¼Œåœ¨å¾®æœåŠ¡ä¸­æ·»åŠ  `minio` æ‰€éœ€è¦çš„é…ç½®

```yaml
minio:
  accessKey: xxxx
  secretKey: xxxx
  bucket: leadnews
  endpoint: localhost:9000
  readPath: localhost:9000
```

ç¬¬ä¸‰ï¼Œåœ¨å¯¹åº”ä½¿ç”¨çš„ä¸šåŠ¡ç±»ä¸­æ³¨å…¥ `FileStorageService`ï¼Œæ ·ä¾‹å¦‚ä¸‹ï¼š

```java
package com.heima.minio.test;


import com.heima.file.service.FileStorageService;
import com.heima.minio.MinioApplication;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.FileInputStream;
import java.io.FileNotFoundException;

@SpringBootTest(classes = MinioApplication.class)
@RunWith(SpringRunner.class)
public class MinioTest {

    @Autowired
    private FileStorageService fileStorageService;

    @Test
    public void testUpdateImgFile() {
        try {
            FileInputStream fileInputStream = new FileInputStream("E:\\tmp\\ak47.jpg");
            String filePath = fileStorageService.uploadImgFile("", "ak47.jpg", fileInputStream);
            System.out.println(filePath);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```



# æ–‡ç« è¯¦æƒ…

## æ–‡ç« è¯¦æƒ…åŠŸèƒ½

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626203655569.png" alt="image-20240626203655569" style="zoom:40%;" />

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç‚¹å‡»æ–‡ç« ï¼Œå³å¯è·³è½¬è‡³è¯¦æƒ…é¡µé¢ï¼›



## å®ç°æ–¹æ¡ˆ

**æ–¹æ¡ˆä¸€ï¼š**å¯¹äºç”¨æˆ·æŸä¸€æ¡æ–‡ç« ï¼Œæ ¹æ®æ–‡ç« çš„ `id` å»æŸ¥è¯¢æ–‡ç« å†…å®¹è¡¨ï¼Œè¿”å›æ¸²æŸ“é¡µé¢ã€‚

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626204018734.png" alt="image-20240626204018734" style="zoom:40%;" />



ğŸŒŸ **æ–¹æ¡ˆäºŒï¼š** é™æ€æ¨¡æ¿å±•ç¤ºï¼›ï¼ˆæœ¬é¡¹ç›®æ‰€é‡‡ç”¨çš„æ–¹å¼ â€¼ï¸ï¼‰

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626204259165.png" alt="image-20240626204259165" style="zoom:38%;" />

## å…·ä½“å®ç°

1. åœ¨ `artile` å¾®æœåŠ¡ä¸­æ·»åŠ  `MinIO` å’Œ `freemarker` çš„æ”¯æŒï¼›

2. åœ¨ `article` å¾®æœåŠ¡ resources/templates ç›®å½•ä¸‹åˆ›å»º æ¨¡æ¿æ–‡ä»¶ï¼ˆarticle.ftlï¼‰ï¼›

3. å°† `index.js` å’Œ `index.css` ä¸¤ä¸ªæ–‡ä»¶æ‰‹åŠ¨ä¸Šä¼ åˆ° `MinIO` ä¸­ï¼›

<img src="../media/2024-06-26-%E6%96%87%E7%AB%A0%E5%88%97%E8%A1%A8%E6%9F%A5%E7%9C%8B/image-20240626205814978.png" alt="image-20240626205814978" style="zoom:33%;" />

4. åœ¨æ–‡ç« å¾®æœåŠ¡ä¸­å¯¼å…¥ä¾èµ–

```xml
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-freemarker</artifactId>
        </dependency>
        <dependency>
            <groupId>com.heima</groupId>
            <artifactId>heima-file-starter</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

5. æ–°å»º `ApArticleContentMapper`

```java
@Mapper
public interface ApArticleContentMapper extends BaseMapper<ApArticleContent> {
}
```







